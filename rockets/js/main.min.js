var population,lifespan=400,popsize=200,count=0,target,maxforce=.2,obnumer=12,obstacles=[],slider,totalCrashed=0,totalComplete=0,iteration=1,bestFit=0;function setup(){createCanvas(740,580);population=new Population(popsize);target=createVector(width/2,50);var a=new Obstacle(150,250,400,10),c=new Obstacle(150,350,200,10),d=new Obstacle(450,350,200,10),b=new Obstacle(550,50,10,250);obstacles.push(a);obstacles.push(c);obstacles.push(d);obstacles.push(b);slider=createSlider(0,255,127)}
function draw(){background(0);textSize(16);fill(255,255,255);text("Iteration: "+iteration,10,30);fill(0,255,0);text("Completed: "+totalComplete,10,60);fill(255,0,0);text("Crashed: "+totalCrashed,10,90);fill(255,204,0);text("Fitness: "+bestFit,10,120);fill(255);for(var a=0;a<obstacles.length;a++)obstacles[a].show();ellipse(target.x,target.y,16,16);population.run();count++;count==lifespan&&(totalComplete=totalCrashed=0,iteration++,population.evaluate(),population.selection(),count=0)}
function Obstacle(a,c,d,b){this.rx=a;this.ry=c;this.rw=d;this.rh=b;this.show=function(){rect(this.rx,this.ry,this.rw,this.rh)}}
function Population(a){this.rockets=[];this.popsize=a?a:200;this.matingpool=[];for(var c=0;c<this.popsize;c++)this.rockets[c]=new Rocket;this.evaluate=function(){for(var d=0,b=0;b<this.popsize;b++)this.rockets[b].calcFitness(),this.rockets[b].fitness>d&&(d=this.rockets[b].fitness);bestFit=d/a;for(b=0;b<this.popsize;b++)this.rockets[b].fitness/=d;this.matingpool=[];for(b=0;b<this.popsize;b++)for(var d=100*this.rockets[b].fitness,c=0;c<d;c++)this.rockets[b].col=color(255,204,0,150),this.matingpool.push(this.rockets[b])};
this.selection=function(){for(var d=[],b=0;b<this.rockets.length;b++){var a=random(this.matingpool),c=random(this.matingpool),e=a.dna.crossover(c.dna);e.mutation();a=a.complete||c.complete?color(0,255,0,150):a.col;d[b]=new Rocket(e,a)}this.rockets=d};this.run=function(){for(var d=0;d<this.popsize;d++)this.rockets[d].update(),this.rockets[d].show()}}
function DNA(a){if(a)this.genes=a;else for(this.genes=[],a=0;a<lifespan;a++)this.genes[a]=p5.Vector.random2D(),this.genes[a].setMag(maxforce);this.crossover=function(a){for(var d=[],b=floor(random(this.genes.length)),c=0;c<this.genes.length;c++)d[c]=c>b?this.genes[c]:a.genes[c];return new DNA(d)};this.mutation=function(){for(var a=0;a<this.genes.length;a++).01>random(1)&&(this.genes[a]=p5.Vector.random2D(),this.genes[a].setMag(maxforce))}}
function Rocket(a,c){this.pos=createVector(width/2,height);this.vel=createVector();this.acc=createVector();this.registered=this.crashed=this.complete=!1;this.col=c?c:color(255,150);this.dna=a?a:new DNA;this.fitness=0;this.applyForce=function(a){this.acc.add(a)};this.calcFitness=function(){var a=dist(this.pos.x,this.pos.y,target.x,target.y);this.fitness=map(a,0,width,width,0);this.complete&&(this.fitness*=10);this.crashed&&(this.fitness/=10)};this.update=function(){10>dist(this.pos.x,this.pos.y,target.x,
target.y)&&(this.complete=!0,this.pos=target.copy(),this.col=color(0,255,0,150));for(var a=0;a<obstacles.length;a++)this.pos.x>obstacles[a].rx&&this.pos.x<obstacles[a].rx+obstacles[a].rw&&this.pos.y>obstacles[a].ry&&this.pos.y<obstacles[a].ry+obstacles[a].rh&&(this.crashed=!0,this.col=color(255,0,0,150));if(this.pos.x>width||0>this.pos.x)this.crashed=!0,this.col=color(255,0,0,150);if(this.pos.y>height||0>this.pos.y)this.crashed=!0,this.col=color(255,0,0,150);this.crashed&&!this.registered&&(totalCrashed+=
1,this.registered=!0);this.complete&&!this.registered&&(totalComplete+=1,this.registered=!0);this.applyForce(this.dna.genes[count]);this.complete||this.crashed||(this.vel.add(this.acc),this.pos.add(this.vel),this.acc.mult(.5),this.vel.limit(4))};this.show=function(){push();noStroke();fill(this.col);translate(this.pos.x,this.pos.y);rotate(this.vel.heading());rectMode(CENTER);rect(0,0,25,5);pop()}};
