var mx=0,my=0,dragw=0,dragh=0,tempdragw=0,tempdragh=0,tempmx=0,tempmy=0,typeElm="OBS",target,startPoint,containerBtns,population,lifespan=400,popsize=200,count=0,maxforce=.2,obnumer=12,obstacles=[],totalCrashed=0,totalComplete=0,iteration=1,bestFit=0,start=!1;
function setup(){createCanvas(window.innerWidth-30,window.innerHeight-30);containerBtns=createDiv("");containerBtns.id("btns");containerBtnsStop=createDiv("");containerBtnsStop.id("btnStopDiv");containerBtnsStop.hide();Obsbutn=createButton("Obstacle");Obsbutn.position(80,20);Obsbutn.parent("btns");Obsbutn.mousePressed(function(){changeElm("OBS")});targetBtn=createButton("Target");targetBtn.position(170,20);targetBtn.parent("btns");targetBtn.mousePressed(function(){changeElm("TRG")});startBtn=createButton("Start");
startBtn.position(240,20);startBtn.parent("btns");startBtn.mousePressed(function(){changeElm("STR")});playBtn=createButton("Play");playBtn.position(19,20);playBtn.parent("btns");playBtn.mousePressed(function(){typeElm="PLAY";startPoint&&target?(containerBtns.hide(),containerBtnsStop.show(),count=0,start=!0):alert("Seleccione un punto de partida y un Objetivo")});stopBtn=createButton("Stop");stopBtn.position(19,20);stopBtn.parent("btnStopDiv");stopBtn.mousePressed(function(){typeElm="STOP";count=lifespan;
start=!1;containerBtns.show();containerBtnsStop.hide()})}
function draw(){background(0);noStroke();fill(255,80);rect(width-220,5,150,165,5);textSize(16);fill(51,122,183);text("Lifespan: ",width-200,30);rect(width-130,20,calculateProgress(lifespan-count,40,lifespan),5);fill(91,192,222);text("Iteration: "+iteration,width-200,150);fill(92,184,92);text("Completed: "+totalComplete,width-200,60);fill(217,83,79);text("Crashed: "+totalCrashed,width-200,90);fill(240,173,78);text("Fitness: "+round(bestFit),width-200,120);fill(0,255,0);text("X: "+mouseX,mouseX,mouseY-
20);fill(255);text("Y: "+mouseY,mouseX,mouseY);"OBS"===typeElm&&rect(tempmx,tempmy,tempdragw,tempdragh);if(!mouseIsPressed){if(dragw&&dragh&&"OBS"===typeElm){var b=new Obstacle(mx,my,dragw,dragh);obstacles.push(b);console.log(obstacles)}mx&&my&&("TRG"===typeElm?(target=new Target(mx,my),console.log(target)):"STR"===typeElm&&(startPoint=new Target(mx,my,"START"),population=new Population(popsize),console.log(startPoint)));tempdragh=tempdragw=tempmy=tempmx=dragh=dragw=my=mx=0}for(b=0;b<obstacles.length;b++)obstacles[b].show();
target&&target.show();startPoint&&startPoint.show();start&&startPoint&&target&&(population.run(),count++,count==lifespan&&(totalComplete=totalCrashed=0,iteration++,population.evaluate(),population.selection(),count=0))}function calculateProgress(b,c,a){return 100*b/a*c/100}function getJsonObs(){for(var b=[],c=0;c<obstacles.length;c++){var a=obstacles[c];b.push({rx:a.rx,ry:a.ry,rw:a.rw,rh:a.rh})}return b}function changeElm(b){typeElm=b}
function Target(b,c,a){this.pos=createVector(b,c);this.d=15;this.type=a?a:"END";this.show=function(){var a=color(0,70,255);"END"===this.type&&(a=color(0,255,70));ellipseMode(RADIUS);fill(0);stroke(a);strokeWeight(2);ellipse(this.pos.x,this.pos.y,this.d,this.d);ellipseMode(CENTER);fill(a);noStroke(a);ellipse(this.pos.x,this.pos.y,this.d,this.d)}}function Obstacle(b,c,a,d){this.rx=b;this.ry=c;this.rw=a;this.rh=d;this.show=function(){fill(255);rect(this.rx,this.ry,this.rw,this.rh)}}
function Population(b){this.rockets=[];this.popsize=b?b:200;this.matingpool=[];for(var c=0;c<this.popsize;c++)this.rockets[c]=new Rocket;this.evaluate=function(){for(var a=0,d=0;d<this.popsize;d++)this.rockets[d].calcFitness(),this.rockets[d].fitness>a&&(a=this.rockets[d].fitness);bestFit=a/b;for(d=0;d<this.popsize;d++)this.rockets[d].fitness/=a;this.matingpool=[];for(d=0;d<this.popsize;d++)for(var a=100*this.rockets[d].fitness,c=0;c<a;c++)this.rockets[d].col=color(255,204,0,150),this.matingpool.push(this.rockets[d])};
this.selection=function(){for(var a=[],b=0;b<this.rockets.length;b++){var c=random(this.matingpool),f=random(this.matingpool),g=c.dna.crossover(f.dna);g.mutation();c=c.complete||f.complete?color(0,255,0,150):c.col;a[b]=new Rocket(g,c)}this.rockets=a};this.run=function(){for(var a=0;a<this.popsize;a++)this.rockets[a].update(),this.rockets[a].show()}}
function DNA(b){if(b)this.genes=b;else for(this.genes=[],b=0;b<lifespan;b++)this.genes[b]=p5.Vector.random2D(),this.genes[b].setMag(maxforce);this.crossover=function(b){for(var a=[],c=floor(random(this.genes.length)),e=0;e<this.genes.length;e++)a[e]=e>c?this.genes[e]:b.genes[e];return new DNA(a)};this.mutation=function(){for(var b=0;b<this.genes.length;b++).01>random(1)&&(this.genes[b]=p5.Vector.random2D(),this.genes[b].setMag(maxforce))}}
function Rocket(b,c){this.pos=startPoint?startPoint.pos.copy():createVector(width/2,height);this.vel=createVector();this.acc=createVector();this.registered=this.crashed=this.complete=!1;this.col=c?c:color(255,150);this.dna=b?b:new DNA;this.fitness=0;this.applyForce=function(a){this.acc.add(a)};this.calcFitness=function(){var a=dist(this.pos.x,this.pos.y,target.pos.x,target.pos.y);this.fitness=map(a,0,width,width,0);this.complete&&(this.fitness*=10);this.crashed&&(this.fitness/=10)};this.update=function(){10>
dist(this.pos.x,this.pos.y,target.pos.x,target.pos.y)&&(this.complete=!0,this.pos=target.pos.copy(),this.col=color(0,255,0,150));for(var a=0;a<obstacles.length;a++)this.pos.x>obstacles[a].rx&&this.pos.x<obstacles[a].rx+Math.abs(obstacles[a].rw)&&this.pos.y>obstacles[a].ry&&this.pos.y<obstacles[a].ry+Math.abs(obstacles[a].rh)&&(this.crashed=!0,this.col=color(255,0,0,150));if(this.pos.x>width||0>this.pos.x)this.crashed=!0,this.col=color(255,0,0,150);if(this.pos.y>height||0>this.pos.y)this.crashed=!0,
this.col=color(255,0,0,150);this.crashed&&!this.registered&&(totalCrashed+=1,this.registered=!0);this.complete&&!this.registered&&(totalComplete+=1,this.registered=!0);this.applyForce(this.dna.genes[count]);this.complete||this.crashed||(this.vel.add(this.acc),this.pos.add(this.vel),this.acc.mult(.5),this.vel.limit(4))};this.show=function(){push();noStroke();fill(this.col);translate(this.pos.x,this.pos.y);rotate(this.vel.heading());rectMode(CENTER);rect(0,0,25,5);pop()}}
function mouseDragged(){dragw=mouseX-mx;dragh=mouseY-my;tempdragw=mouseX-tempmx;tempdragh=mouseY-tempmy;0>tempdragw&&(dragw=abs(tempdragw),mx=mouseX);0>tempdragh&&(dragh=abs(tempdragh),my=mouseY);return!1}function mousePressed(){mx=mouseX;my=mouseY;tempmx=mouseX;tempmy=mouseY;return!1};
